<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Steam Dashboard 2.0</title>
    <link rel="stylesheet" href="css/home.css" />
  </head>
  <body>
    <div class="bg-animation"></div>
    <div class="stars" id="stars"></div>

    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-brand">
        <div class="logo">üéÆ STEAM DB</div>
      </div>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar"></div>
        <span class="user-name" id="userName"></span>
        <button class="logout-btn" onclick="cerrarSesion()">
          üö™ Cerrar Sesi√≥n
        </button>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Hero Section -->
      <section class="hero-section">
        <h1 class="hero-title" id="dashboardTitle">Bienvenido al Dashboard</h1>
        <p class="hero-subtitle">
          Explora tu biblioteca de juegos y descubre nuevas aventuras
        </p>
      </section>

      <!-- Control Panel -->
      <div class="control-panel">
        <h2 class="panel-title">Panel de Control</h2>

        <div class="controls-grid">
          <div class="control-card" onclick="callEndpoint('juegos_baratos')">
            <div class="card-icon">üí∞</div>
            <div class="card-title">Juegos Econ√≥micos</div>
            <div class="card-description">Precios ‚â§ $20</div>
          </div>

          <div class="control-card" onclick="callEndpoint('juegos_caros')">
            <div class="card-icon">üíé</div>
            <div class="card-title">Juegos Premium</div>
            <div class="card-description">Precios > $20</div>
          </div>

          <div class="control-card" onclick="mostrarEstadisticas()">
            <div class="card-icon">üìà</div>
            <div class="card-title">Estad√≠sticas</div>
            <div class="card-description">Ver an√°lisis completo</div>
          </div>
        </div>

        <div class="filter-section">
          <span class="filter-label">üéØ Filtrar por categor√≠a:</span>
          <select
            id="categoriaSelect"
            class="category-select"
            onchange="filtrarPorCategoria()"
          >
            <option value="">Todas las categor√≠as</option>
          </select>
        </div>
      </div>

      <!-- Data Section -->
      <div class="data-section">
        <h2 class="data-title">Resultados</h2>
        <div id="endpoint-data">
          <div class="empty-state">
            <div class="empty-icon">üéÆ</div>
            <div class="empty-text">
              Selecciona una opci√≥n para ver los datos
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const nombreUsuario = localStorage.getItem("usuarioNombre");
      if (nombreUsuario) {
        document.getElementById("userName").textContent = nombreUsuario;
        document.getElementById("userAvatar").textContent = nombreUsuario
          .charAt(0)
          .toUpperCase();

        // üëá Esta l√≠nea nueva actualiza el H1
        document.getElementById(
          "dashboardTitle"
        ).textContent = `Bienvenido al Dashboard, ${nombreUsuario}`;
      } else {
        window.location.href = "index.html";
      }
      // Cargar categor√≠as al iniciar
      async function cargarCategorias() {
        const token = localStorage.getItem("token");
        try {
          const res = await fetch("http://localhost:3000/categorias", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!res.ok) throw new Error("Error al cargar categor√≠as");

          const categorias = await res.json();
          const select = document.getElementById("categoriaSelect");

          select.innerHTML = '<option value="">Todas las categor√≠as</option>';

          categorias.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Error al cargar categor√≠as:", err);
        }
      }

      function cerrarSesion() {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "index.html";
      }

      function callEndpoint(endpointName) {
        const button = event.target.closest(".control-card");
        const container = document.getElementById("endpoint-data");

        container.innerHTML =
          '<div style="text-align: center; padding: 3rem;"><div class="loading"></div><p style="color: #94a3b8; margin-top: 1rem;">Cargando datos...</p></div>';

        const token = localStorage.getItem("token");
        fetch(`http://localhost:3000/${endpointName}`, {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.length === 0) {
              container.innerHTML =
                '<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-text">No se encontraron resultados</div></div>';
              return;
            }

            let tableHTML = '<table class="data-table"><thead><tr>';

            Object.keys(data[0]).forEach((key) => {
              const displayName =
                key.charAt(0).toUpperCase() + key.slice(1).replace("_", " ");
              tableHTML += `<th>${displayName}</th>`;
            });
            tableHTML += "</tr></thead><tbody>";

            data.forEach((item) => {
              tableHTML += "<tr>";
              Object.entries(item).forEach(([key, value]) => {
                let cellClass = "";
                let displayValue = value;

                if (
                  key.toLowerCase().includes("precio") ||
                  key.toLowerCase().includes("price")
                ) {
                  cellClass = "price";
                  if (typeof value === "number") {
                    displayValue = `$${value.toLocaleString()}`;
                  }
                } else if (
                  key.toLowerCase().includes("nombre") ||
                  key.toLowerCase().includes("name") ||
                  key.toLowerCase().includes("titulo") ||
                  key.toLowerCase().includes("title")
                ) {
                  cellClass = "name";
                }

                tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
              });
              tableHTML += "</tr>";
            });

            tableHTML += "</tbody></table>";
            container.innerHTML = tableHTML;
          })
          .catch((err) => {
            console.error(err);
            container.innerHTML =
              '<div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-text">Error al cargar los datos</div></div>';
          });
      }

      async function filtrarPorCategoria() {
        const categoria = document.getElementById("categoriaSelect").value;
        const container = document.getElementById("endpoint-data");

        if (!categoria) {
          container.innerHTML =
            '<div class="empty-state"><div class="empty-icon">üéÆ</div><div class="empty-text">Selecciona una categor√≠a</div></div>';
          return;
        }

        container.innerHTML =
          '<div style="text-align: center; padding: 3rem;"><div class="loading"></div><p style="color: #94a3b8; margin-top: 1rem;">Cargando juegos...</p></div>';

        const token = localStorage.getItem("token");
        const res = await fetch(
          `http://localhost:3000/juegos/categoria/${categoria}`,
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-text">No hay juegos en esta categor√≠a</div></div>';
          return;
        }

        let tableHTML =
          '<table class="data-table"><thead><tr><th>T√≠tulo</th><th>Precio</th><th>Estado</th></tr></thead><tbody>';
        data.forEach((j) => {
          const disponible = j.disponible
            ? '<span class="badge badge-success">‚úì Disponible</span>'
            : '<span class="badge badge-danger">‚úó No disponible</span>';
          tableHTML += `<tr><td class="name">${j.titulo}</td><td class="price">$${j.precio}</td><td>${disponible}</td></tr>`;
        });
        tableHTML += "</tbody></table>";
        container.innerHTML = tableHTML;
      }

      async function mostrarEstadisticas() {
        const container = document.getElementById("endpoint-data");
        container.innerHTML = "<p>Cargando juegos...</p>";

        try {
          const response = await fetch("http://localhost:3000/api/juegos", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });

          if (!response.ok) throw new Error("Error al obtener los juegos");

          const juegos = await response.json();

          // Mostrar todos los juegos
          const juegosHTML = juegos
            .map(
              (j) => `
      <div class="juego-card">
        <h3>${j.nombre}</h3>
        <p><strong>Precio:</strong> $${j.precio}</p>
        <p><strong>Categor√≠a:</strong> ${j.categoria}</p>
      </div>
    `
            )
            .join("");

          // Calcular estad√≠sticas
          const totalJuegos = juegos.length;
          const valorTotal = juegos.reduce(
            (acc, j) => acc + (parseFloat(j.precio) || 0),
            0
          );

          container.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value">${totalJuegos}</div><div class="stat-label">Total Juegos</div></div>
        <div class="stat-card"><div class="stat-value">$${valorTotal.toFixed(
          2
        )}</div><div class="stat-label">Valor Total</div></div>
      </div>
    `;
        } catch (error) {
          console.error(error);
          container.innerHTML = "<p>Error al cargar los juegos üò¢</p>";
        }
      }

      function createStars() {
        const starsContainer = document.getElementById("stars");
        for (let i = 0; i < 100; i++) {
          const star = document.createElement("div");
          star.className = "star";
          star.style.left = Math.random() * 100 + "%";
          star.style.top = Math.random() * 100 + "%";
          star.style.animationDelay = Math.random() * 3 + "s";
          starsContainer.appendChild(star);
        }
      }

      createStars();
      cargarCategorias();
    </script>
  </body>
</html>
